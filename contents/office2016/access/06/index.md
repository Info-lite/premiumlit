---
layout: page
title: リレーションシップ（２）
date: 2015-10-15 11:47:04 +0900
purposes:
    - リレーションシップの構造をより詳しく学ぶ
    - データを変更することによって、リレーションシップが働いていることを再確認する
---


<div class="panel panel-info">
<div class="panel-body">
今回使うファイルです。ダウンロードしてください。
<ul>
<li><a href="../assets/pencil.accdb">pencil.accdb</a></li>
<li><a href="../assets/paper.accdb">paper.accdb</a></li>
</ul>
</div>
</div>


リレーションシップ
------------------

### 主キーと外部キー

データを効率よく管理し、かつ矛盾したデータの入力を防ぐために、テーブルをいくつかに分けます。
他のテーブルの上方を参照するためにリレーションシップ（関係づけ）を作成します。

リレーションシップを作るには、共通のフィールドが必要です。
リレーションシップを形成する際に 1 件のレコードに対し、複数件のレコードを対応させる場合、 1 件のレコードが入力されている方を一側テーブルと言い、複数件のレコードが入力されている方を多側テーブルと言います。
メインとなる一側テーブルには、主キーを設定します。多側テーブルの同様の情報が入力されたフィールドを外部キーと呼び、主キーと外部キーを一致させることによってリレーションシップを形成します。

{% screenshot key.png "主キーと外部キーの例" %}

### リレーションシップの種類


#### 一対多リレーションシップ

最も使用頻度の多いリレーションシップです。
一側テーブルからの 1 件のレコードと多側テーブルからの複数件のレコードを組み合わせたリレーションシップです。上の画像が例としてあげられます。

#### 一対一リレーションシップ

一側テーブルからの 1 件のレコードと多側テーブルからの 1 件のレコードを組み合わせたリレーションシップです。

{% screenshot 11table.png "一対一リレーションシップの例" %}

#### 多対多リレーションシップ

一側テーブルからの 1 件のレコードと多側テーブルからの複数件のレコードを組み合わせ、また、多側テーブルからの複数件のレコードと別の一側テーブルからの 1 件のレコードを組み合わせたリレーションシップです。

一つめの一側テーブルの主キーと多側テーブルの外部キーがリレーションシップされ、さらに別の一側テーブルの主キーと多側テーブルの外部キーがリレーションシップします。

{% screenshot 1t1table.png "多対多リレーションシップの例" %}


### リレーションシップを作成する

今回から"pencil.accdb"を使用します。ダウンロードして開いてください。

"pencil.accdb"からリレーションシップを作成していきます。

{% screenshot open.png "pencil.accdb 初期状態" %}

&#9312; [データベース ツール]タブ - [リレーションシップ] - [リレーションシップ]をクリックします。

{% screenshot relationship1.png "リレーションシップ アイコンの場所" %}

&#9313; [リレーションシップ ツール] - [デザイン]タブ - [リレーションシップ] - [テーブルの表示]をクリックします。

{% screenshot relationship2.png "テーブルの表示 アイコンの場所" %}

&#9314; "テーブルの表示"ウィンドウから以下のテーブルを選択 - [追加]をクリック - [閉じる]をクリックします。

-   顧客マスター
-   受注
-   受注明細
-   商品マスター
-   地域

{% screenshot relationship3.png "テーブルの表示ウィンドウ" %}

{% screenshot relationship4.png "テーブル追加後" %}

&#9315; "顧客マスター"テーブルの全てのフィールドリストが見えるようにサイズを拡大します。

{% screenshot relationship5.png "[顧客マスター]テーブルのフィールドリストの拡大" %}

&#9316;. "受注"テーブルのフィールドリストの下に"地域"テーブルのフィールドリストを移動します。

{% screenshot relationship6.png "[地域]テーブルのフィールドリストの移動" %}

&#9317; "顧客マスター"テーブルの"顧客ＩＤ"フィールドを"受注"テーブルの"顧客ＩＤ"フィールドにドラッグアンドドロップします。

{% screenshot relationship7.png "[顧客ID]フィールドをドラッグアンドドロップ" %}

&#9318; [作成]をクリックします。

{% screenshot relationship8.png "リレーションシップ 作成ウィンドウ" %}

&#9319; 結合線を確認してください。

{% screenshot relationship9.png "リレーションシップ作成後" %}

&#9320; 同様に以下のリレーションシップを作成します。

-   "受注"テーブルと"受注明細"テーブル："受注ＩＤ"フィールド
-   "受注明細"テーブルと"商品マスター"テーブル："商品コード"フィールド
-   "地域"テーブルと"顧客マスター"テーブル："地域コード"フィールド

{% screenshot relationship10.png "各リレーションシップ作成後" %}

&#9321; 上書き保存をして、リレーションシップのウィンドウを閉じます。


### クエリでテーブルを結合する

"顧客マスター"、"受注"、"受注明細"、"商品マスター"の各テーブルを使って、受注した商品の詳細を一覧で表示します。

&#9312; [作成]タブ - [クエリ] - [クエリデザイン]をクリックします。

{% screenshot createquery1.png "クエリデザイン アイコンの場所" %}

{% screenshot createquery2.png "テーブルの表示" %}

&#9313; テーブルタブから以下のテーブルを選択 - [追加]をクリック - [閉じる]をクリックします。

-   顧客マスター
-   受注
-   受注明細
-   商品マスター

{% screenshot createquery3.png "テーブルの選択" %}

{% screenshot createquery4.png "テーブル追加後" %}

&#9314; "クエリ1"ウィンドウを最大化し、見やすくします。

&#9315; 結合線を確認します。

{% screenshot createquery5.png "結合線の確認" %}

&#9316; "受注明細"の"受注ＩＤ"をダブルクリックします。

{% screenshot createquery6.png "[受注明細]の[受注ＩＤ]フィールドの追加" %}

&#9317; 同様に以下のテーブルから以下のフィールドを追加してください。

-   "受注"テーブル："受注日"フィールド
-   "受注"テーブル："顧客ＩＤ"フィールド
-   "顧客マスター"テーブル："顧客名"フィールド
-   "受注明細"テーブル："商品コード"フィールド
-   "商品マスター"テーブル："商品名"フィールド
-   "商品マスター"テーブル："定価"フィールド
-   "受注明細"テーブル："数量"フィールド

&#9318; [クエリツール] - [デザイン]タブ - [結果] - ![](../pic/action.png) ([実行])ボタンをクリックします。

{% screenshot createquery7.png "実行アイコンの場所" %}

{% screenshot createquery8.png "クエリ実行後" %}

&#9319; `Ｑ受注登録` と入力して、名前を付けて保存します。


### クエリでデータを変更する

&#9312; "Ｑ受注登録"の一番上のレコードの"顧客ＩＤ"フィールドの値を `1` に変更 - [Enter]キーをクリックします。

{% screenshot revisequery1.png "[顧客ＩＤ]フィールドの値を <font color="red">1</font> に変更" %}

"顧客名"フィールドが"山本浩史"に変わりました。

{% screenshot revisequery2.png "[顧客ＩＤ]フィールドの値変更後" %}

&#9313; 一番上のレコードの"商品コード"フィールドの値を `K-200` に変更 - [Enter]キーをクリックします。

{% screenshot revisequery3.png "[商品コード]フィールドの値を <font color="red">K-200</font> に変更" %}

"商品名"フィールドが"はがき"に変わりました。

{% screenshot revisequery4.png "[商品コード]フィールドの値変更後" %}

&#9314; 上書き保存をして、レコードを保存します。


### 演算フィールドを追加する

&#9312; "デザインビュー"に切り替えます。

{% screenshot calcquery1.png "デザインビュー アイコンの場所" %}

&#9313; "数量"フィールドの右側に `金額:定価*数量` と入力 - [Enter]キーをクリックし、 [クエリツール] - [デザイン]タブ - [結果] - ![](../pic/action.png) ([実行])をクリックします。

{% screenshot calcquery2.png "`金額:定価*数量`フィールドの追加入力" %}

&#9314; "金額"フィールドが追加されました。

{% screenshot calcquery3.png "[金額]フィールド追加後" %}

&#9315; 上書き保存をします。


課題
----

"paper.accdb"にもリレーションシップを設定します。授業の初めにダウンロードした"paper.accdb"を開き、以下の指示に従って、リレーションシップを作成してください。

1. 以下のテーブルをリレーションシップウィンドウに追加してください。
    -   顧客マスター
    -   受注
    -   受注明細
    -   商品マスター
    -   地域
2. 以下のフィールド間でリレーションシップを設定してください。
    - "顧客マスター"テーブルと"受注"テーブル："顧客ＩＤ"フィールド
    - "受注"テーブルと"受注明細"テーブル："受注ＩＤ"フィールド
    - "受注明細"テーブルと"商品マスター"テーブル："商品コード"フィールド
    - "地域"テーブルと"顧客マスター"テーブル："地域コード"フィールド
3. リレーションシップを保存します。
4. 以下の要素からなるクエリを作成します。
    -   "受注明細"テーブル："受注ＩＤ"フィールド
    -   "受注"テーブル："受注日"フィールド
    -   "受注"テーブル："顧客ＩＤ"フィールド
    -   "顧客マスター"テーブル："顧客名"フィールド
    -   "受注明細"テーブル："商品コード"フィールド
    -   "商品マスター"テーブル："商品名"フィールド
    -   "商品マスター"テーブル："定価"フィールド
    -   "受注明細"テーブル："数量"フィールド
1. 作成したら、リレーションシップが正常に作動しているかどうかを調べるために以下の変更を加えます。
5. 一番上のレコード（受注IDが1、顧客名が伊東祐子、商品コードがB-500）の"顧客ID"フィールドの値を `15` に変更し、"顧客名"フィールドが `畠山慶` になることを確認します。
6. 同じレコードの"商品コード"を `S-400` に変更し、"商品名"が `鉛筆` になり、"定価"が `&yen;1,200` になることを確認します。
7. 最後に、演算フィールドを追加します。
8. デザインビューに切り替え、"数量"フィールドの右側に、表示名を `金額` とし、数量と定価と8%の消費税を掛け合わせたものを追加してください。
9. [実行]をクリックして、"金額"フィールドが追加され、一番上のレコード（受注IDが３、顧客名が長野業平、商品コードがB-500）のものが `14040` になることを確認します。
10. "受注明細クエリ"として保存し、閉じます。

ヒント：消費税が8%だと、消費税分は元の金額に0.08を掛けたものです。では、最終的な値段は何倍になりますか？
操作が分からなければ第12講で"年会費"をどうやって作ったのか思い出してみましょう。
